<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>高德地图demo</title>
    <script src="./jquery.js"></script>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.3&key=2204a199f8452326d30041dfd06d0f1e"></script> 
    <style>
        .startBtn,.preBtn{
            display: none;
        }

        .selected{
            background-color: black;
            color: white;
        }
    </style>
</head>
<body>
    <div id="container" style="width:1000px; height:500px">

    </div>
    <br />
    <br />
    <br />
    <button class="startBtn">首页</button>
    <button class="preBtn">上一页</button>
    <!-- <button>1</button>
    <button>2</button>
    <button>3</button>
    <button>4</button> -->
    <button class="nextBtn">下一页</button>
    <button class="endBtn">尾页</button>
    <script>
        // 地图的初始化
        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 11,
            center: [116.397428, 39.90923]        
        });

        AMap.plugin(['AMap.ToolBar','AMap.Scale','AMap.OverView'],
            function(){
                map.addControl(new AMap.ToolBar());

                map.addControl(new AMap.Scale());

                map.addControl(new AMap.OverView({isOpen:true}));
        });

        // var marker = new AMap.Marker({
        //     position: [116.397428, 39.90923],
        //     map: map
        // });
        // // marker.setMap(map);

        // //给Marker绑定单击事件
        // marker.on('click', openInfo);


        
        // 创建窗体的方法
         //在指定位置打开信息窗体
        var infoWindow;
        function openInfo(shopObj) {
            //构建信息窗体中显示的内容
            var info = [];
            info.push("<div><div><img style=\"float:left;\" src=\" https://webapi.amap.com/images/autonavi.png \"/></div> ");
            info.push("<div style=\"padding:0px 0px 0px 4px;\"><b>" + shopObj.shop_name + "</b>");
            info.push("电话 : 010-84107000   邮编 : 100102");
            info.push("地址 :北京市朝阳区望京阜荣街10号首开广场4层</div></div>");
            infoWindow = new AMap.InfoWindow({
                content: info.join("<br/>")  //使用默认信息窗体框样式，显示信息内容
            });
            infoWindow.open(map, [shopObj.map_longitude, parseFloat(shopObj.map_latitude) + 0.02]);
        }

        // openInfo();
        var markers = [];
        var isLoadBtn = false;
        // 页码数量（按钮数量）
        var btnCount;
        function loadData (pageNo, pageSize) {
            $.ajax({
                url: 'http://127.0.0.1:8888/getShopList',
                type: 'get',
                dataType: 'json',
                cache: false,
                data: { pageNo, pageSize },
                success(data) {
                    console.log(data);
                    // console.log(map);
                    map.remove(markers);
                    if (!isLoadBtn) {
                        // 计算显示页码按钮数量
                        btnCount = parseInt(data.page_count) / 10;
                        var btnStr = '';
                        for (var i = 0; i < btnCount; i++) {
                            btnStr += '<button name="s">' + (i + 1) + '</button>';
                        }
                        $(btnStr).insertAfter('.preBtn');

                        $('.preBtn').next().addClass('selected');

                        $('button').click(pageClick);
                    }
                    
                    // 解析数据
                    for (var tempShop of data.shop_list) {
                        // 可以用let替换下面这种方式
                        (function (tempShop) {
                            // 创建marker
                            var marker = new AMap.Marker({
                                position: [tempShop.map_longitude, tempShop.map_latitude],
                                map: map
                            });
                            //给Marker绑定单击事件
                            marker.on('click', function () {
                                console.log(tempShop.shop_name);
                                openInfo(tempShop);
                            });
                            markers.push(marker);
                        })(tempShop);
                    }
                    isLoadBtn = true;
                }
            });
        }
        loadData(0, 10);

        var pageNo = 0;
        // 分页逻辑
        function pageClick () {
            switch ($(this).html()) {
                case '首页':
                    pageNo = 0;
                    break;
                case '上一页':
                    pageNo--;
                    break;
                case '尾页':
                    pageNo = btnCount - 1;
                    break;
                case '下一页':
                    pageNo++;
                    break;
                default:
                    pageNo = parseInt($(this).html()) - 1;
                    break;
            }

            console.log(pageNo);

            //2、处理首尾、上下按钮隐藏显示
            if (pageNo == 0) {
                $('.startBtn').css('display', 'none');
                $('.preBtn').css('display', 'none');
            } else {
                $('.startBtn').css('display', 'inline-block');
                $('.preBtn').css('display', 'inline-block');
            }

            if (pageNo == (btnCount - 1)) {
                $('.endBtn').css('display', 'none');
                $('.nextBtn').css('display', 'none');
            } else {
                $('.endBtn').css('display', 'inline-block');
                $('.nextBtn').css('display', 'inline-block');
            }

            //3、处理选择样式
            var $s_btn = $('button[name=s]');
            // 把所有页码按钮的样式移除
            $s_btn.removeClass('selected');

            // 然后找到点击后的pageNo对应的按钮，样式加回来，
            // 注意：这里className是原生Dom的
            $s_btn[pageNo].className = 'selected';

            // 更新数据
            loadData(pageNo, 10);
        }

        

    </script>
</body>
</html>